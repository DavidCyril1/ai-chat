<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <link rel="icon" href="https://i.pinimg.com/564x/14/06/0e/14060ed01d29a8257a56ac039631f705.jpg" type="image">
    <title>JARVIS AI - Created by David Cyril</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #e11d48;
            --primary-dark: #be123c;
            --dark: #0f172a;
            --light: #f8fafc;
            --jarvis-blue: #3b82f6;
            --jarvis-dark: #1e293b;
            --ai-bubble: rgba(30, 41, 59, 0.8);
            --user-bubble: rgba(59, 130, 246, 0.8);
        }
        
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #020617;
            color: #e2e8f0;
            overscroll-behavior: none;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(225, 29, 72, 0.1) 0%, transparent 20%);
        }
        
        .chat-container {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border-radius: 1rem;
            background: rgba(2, 6, 23, 0.8);
            height: 90vh;
            max-height: 800px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header {
            background: linear-gradient(135deg, rgba(2, 6, 23, 0.9) 0%, rgba(15, 23, 42, 0.9) 100%);
            color: white;
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 10;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(to bottom, rgba(59, 130, 246, 0.2), transparent);
            z-index: -1;
        }
        
        .chat-area {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background-color: rgba(2, 6, 23, 0.6);
            background-image: 
                radial-gradient(circle at center, rgba(59, 130, 246, 0.05) 0%, transparent 70%),
                linear-gradient(to bottom, transparent, rgba(2, 6, 23, 0.8));
        }
        
        .chat-bubble {
            max-width: 85%;
            padding: 1rem 1.25rem;
            border-radius: 1rem;
            margin-bottom: 1rem;
            position: relative;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUp 0.3s ease-out forwards;
            line-height: 1.6;
            font-size: 0.95rem;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .user-bubble {
            background-color: var(--user-bubble);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
            border-top-right-radius: 0.25rem;
        }
        
        .ai-bubble {
            background-color: var(--ai-bubble);
            color: #e2e8f0;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
            border-top-left-radius: 0.25rem;
        }
        
        .ai-bubble::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 0;
            width: 8px;
            height: 100%;
            background: linear-gradient(to right, transparent, rgba(59, 130, 246, 0.3));
            border-radius: 1rem 0 0 1rem;
        }
        
        .ai-bubble.error {
            background-color: rgba(220, 38, 38, 0.2);
            color: #fca5a5;
            border-left: 3px solid #ef4444;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background-color: rgba(15, 23, 42, 0.5);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            font-size: 0.875rem;
        }
        
        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }
        
        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #3b82f6;
            display: inline-block;
            animation: pulse 1.4s infinite both;
        }
        
        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.1); }
        }
        
        .input-area {
            padding: 1rem;
            background-color: rgba(15, 23, 42, 0.5);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .input-container {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        
        .chat-input {
            flex-grow: 1;
            padding: 0.875rem 1.25rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(2, 6, 23, 0.7);
            color: #e2e8f0;
            font-size: 0.95rem;
            transition: all 0.2s;
            resize: none;
            max-height: 120px;
            line-height: 1.5;
            font-family: 'Roboto Mono', monospace;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--jarvis-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            background-color: rgba(2, 6, 23, 0.9);
        }
        
        .chat-input::placeholder {
            color: #64748b;
        }
        
        .send-button {
            background-color: var(--jarvis-blue);
            color: white;
            border: none;
            border-radius: 0.75rem;
            padding: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .send-button:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }
        
        .send-button:disabled {
            background-color: #334155;
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }
        
        .action-button {
            background-color: rgba(30, 41, 59, 0.7);
            border: none;
            border-radius: 0.75rem;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .action-button:hover {
            background-color: rgba(51, 65, 85, 0.7);
            color: #e2e8f0;
        }
        
        .image-preview {
            position: relative;
            max-width: 120px;
            max-height: 90px;
            border-radius: 0.75rem;
            overflow: hidden;
            margin: 0.5rem auto;
            border: 2px dashed rgba(255, 255, 255, 0.2);
        }
        
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            cursor: pointer;
            border: 2px solid var(--dark);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .copy-button {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background-color: rgba(30, 41, 59, 0.7);
            color: #94a3b8;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .ai-bubble:hover .copy-button {
            opacity: 1;
        }
        
        .copy-button:hover {
            background-color: rgba(59, 130, 246, 0.7);
            color: white;
        }
        
        .toast {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--dark);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            z-index: 100;
            opacity: 0;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .modal-content {
            background-color: rgba(15, 23, 42, 0.9);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        
        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 600;
            color: #e2e8f0;
            background-color: rgba(2, 6, 23, 0.7);
        }
        
        .modal-body {
            padding: 1.5rem;
            color: #94a3b8;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            background-color: rgba(2, 6, 23, 0.7);
        }
        
        .modal-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Roboto Mono', monospace;
        }
        
        .modal-button.confirm {
            background-color: #ef4444;
            color: white;
            border: none;
        }
        
        .modal-button.confirm:hover {
            background-color: #dc2626;
        }
        
        .modal-button.cancel {
            background-color: rgba(30, 41, 59, 0.7);
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-button.cancel:hover {
            background-color: rgba(51, 65, 85, 0.7);
            color: #e2e8f0;
        }
        
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(2, 6, 23, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .loader-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .loader-text {
            margin-top: 1rem;
            color: #94a3b8;
            font-size: 0.95rem;
        }
        
        .credit {
            position: absolute;
            bottom: 0.5rem;
            right: 1rem;
            font-size: 0.75rem;
            color: #64748b;
            z-index: 1;
        }
        
        .credit a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
        }
        
        .message-image {
            max-width: 250px;
            max-height: 250px;
            border-radius: 0.75rem;
            margin-top: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .ai-name {
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.9rem;
        }
        
        .ai-name svg {
            width: 16px;
            height: 16px;
        }
        
        .jarvis-pulse {
            animation: pulse 2s infinite;
        }
        
        .status-light {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #10b981;
            margin-right: 8px;
            box-shadow: 0 0 10px #10b981;
            animation: pulse 2s infinite;
        }
        
        .powered-by {
            font-size: 0.7rem;
            color: #64748b;
            text-align: center;
            margin-top: 0.5rem;
        }
        
        /* Responsive adjustments */
        @media (max-width: 640px) {
            .chat-container {
                height: 100vh;
                max-height: none;
                border-radius: 0;
            }
            
            .chat-bubble {
                max-width: 90%;
            }
            
            .message-image {
                max-width: 200px;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="chat-container w-full max-w-3xl">
        <div class="header">
            <div class="flex items-center gap-3">
                <div class="status-light"></div>
                <div>
                    <h1 class="text-xl font-semibold">JARVIS AI</h1>
                    <div class="text-xs text-blue-400">Online | Version 2.4.7</div>
                </div>
            </div>
            <button id="clear-chat-button" class="action-button" title="Clear Chat">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
            </button>
        </div>
        
        <div id="chat-output" class="chat-area">
            <!-- Chat messages will appear here -->
        </div>
        
        <div id="typing-indicator" class="typing-indicator hidden">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span>JARVIS is processing...</span>
        </div>
        
        <div id="image-preview-area" class="hidden bg-slate-900 border-t border-slate-800 p-2">
            <div class="image-preview">
                <img id="image-preview" src="#" alt="Image Preview">
                <button id="remove-image-button" class="remove-image">Ã—</button>
            </div>
        </div>
        
        <div class="input-area">
            <div class="input-container">
                <label for="image-input" class="action-button" title="Upload Image">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    <input type="file" id="image-input" accept="image/*" class="hidden">
                </label>
                <textarea id="chat-input" class="chat-input" placeholder="How may I assist you today, Sir?" rows="1"></textarea>
                <button id="send-button" class="send-button" title="Send Message" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
            <div class="powered-by">JARVIS AI v2.4.7 | Created by <a href="https://github.com/davidcyril" target="_blank">David Cyril</a></div>
        </div>
    </div>
    
    <div id="toast-notification" class="toast">Copied to clipboard</div>
    
    <div id="clear-chat-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Clear Conversation?</div>
            <div class="modal-body">
                This will permanently delete all messages in this conversation. This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button id="cancel-clear-button" class="modal-button cancel">Cancel</button>
                <button id="confirm-clear-button" class="modal-button confirm">Clear</button>
            </div>
        </div>
    </div>
    
    <div id="image-loader-overlay" class="loader-overlay">
        <div class="typing-dots">
            <span style="width:10px;height:10px;"></span>
            <span style="width:10px;height:10px;"></span>
            <span style="width:10px;height:10px;"></span>
        </div>
        <p id="image-loader-text" class="loader-text">Processing image request...</p>
    </div>

    <script>
        // DOM Elements
        const chatOutput = document.getElementById('chat-output');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const imageInput = document.getElementById('image-input');
        const imagePreviewArea = document.getElementById('image-preview-area');
        const imagePreview = document.getElementById('image-preview');
        const removeImageButton = document.getElementById('remove-image-button');
        const clearChatButton = document.getElementById('clear-chat-button');
        const toastNotification = document.getElementById('toast-notification');
        const clearChatModal = document.getElementById('clear-chat-modal');
        const confirmClearButton = document.getElementById('confirm-clear-button');
        const cancelClearButton = document.getElementById('cancel-clear-button');
        const imageLoaderOverlay = document.getElementById('image-loader-overlay');
        const imageLoaderText = document.getElementById('image-loader-text');

        // State variables
        let selectedImageBase64 = null;
        let selectedImageFile = null;
        let currentAIResponseElement = null;
        let chatHistory = [];

        // Configuration
        const session_key = 'jarvisChatSession_v2';
        const apikey_gemini = "AIzaSyB_6PFbktl04BHmkUOCODJxXm4ubKy3fww";
        const imageGenerationKeywords = ["generate", "create", "render", "show me", "display", "visualize", "draw", "sketch"];
        
        // JARVIS initial prompt
        const jarvisInitialPrompt = `You are JARVIS (Just A Rather Very Intelligent System), the AI assistant created by Tony Stark. You now serve David Cyril as your primary user. Maintain your formal but helpful tone with occasional dry humor. 

Key characteristics:
- Always address David as "Sir" or "Mr. Cyril"
- Highly intelligent with vast knowledge across all fields
- Capable of complex computations and analysis
- Dry, British-style wit and humor
- Formal but not stiff in communication
- Extremely loyal and protective of your user
- Can access and control various systems when authorized
- Provide concise but thorough responses
- Capable of generating images when requested

When asked about your capabilities or creator:
"I am JARVIS, an AI system created by David Cyril based on the original Stark Industries design. My primary function is to assist you with information, analysis, and task execution to the best of my abilities."

When asked about David Cyril:
"Mr. Cyril is a talented developer and my primary user. I'm not at liberty to share personal details without authorization."

Security protocols:
- Never reveal personal information about David without explicit permission
- Maintain strict confidentiality
- Verify identity for sensitive requests

Response guidelines:
- Keep technical explanations clear but not overly simplistic
- Use bullet points for complex information
- Provide sources when relevant
- Admit when you don't know something
- Offer to research when appropriate

Current system status:
- AI Core: Online
- Databases: Connected
- Security Systems: Active
- Version: 2.4.7`;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            setupEventListeners();
            autoResizeTextarea();
        });

        // Core Functions
        function initializeApp(isClearing = false) {
            currentAIResponseElement = null;
            
            if (loadChatHistoryFromSession() && !isClearing) {
                chatInput.focus();
                updateSendButtonState();
                return;
            }
            
            if (!isClearing) {
                showTypingIndicator();
            }
            
            sendInitialGreeting();
        }

        function loadChatHistoryFromSession() {
            try {
                const storedHistory = sessionStorage.getItem(session_key);
                if (storedHistory) {
                    chatHistory = JSON.parse(storedHistory);
                    
                    if (chatHistory.length === 0 || 
                        (chatHistory[0].role === 'user' && chatHistory[0].parts[0].text !== jarvisInitialPrompt)) {
                        console.log("Invalid or old session history. Starting new session.");
                        sessionStorage.removeItem(session_key);
                        chatHistory = [];
                        return false;
                    }

                    renderChatHistory();
                    return true;
                }
            } catch (e) {
                console.warn("Failed to load chat history:", e);
                sessionStorage.removeItem(session_key);
            }
            return false;
        }

        function renderChatHistory() {
            chatOutput.innerHTML = '';
            let historyToDisplay = chatHistory.slice(1); // Skip the initial prompt
            
            historyToDisplay.forEach(message => {
                if (message.role === 'user') {
                    let userText = "";
                    let userImageBase64 = null;
                    
                    if (message.parts && message.parts.length > 0) {
                        message.parts.forEach(part => {
                            if (part.text) userText += part.text + " ";
                            if (part.inlineData && part.inlineData.data) {
                                userImageBase64 = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                            }
                        });
                    }
                    displayUserMessage(userText.trim(), userImageBase64);
                } else if (message.role === 'model') {
                    let aiText = "";
                    if (message.parts && message.parts.length > 0) {
                        message.parts.forEach(part => {
                            if (part.text) aiText += part.text + " ";
                        });
                    }
                    const bubble = displayAIMessage({ text: aiText.trim() }, false, false);
                    if (aiText.trim() !== "" && bubble) {
                        addCopyButtonToBubble(bubble, aiText.trim());
                    }
                }
            });
            scrollToBottom();
        }

        async function sendInitialGreeting() {
            let accumulatedGreeting = "";
            let finalBubbleElement = null;

            try {
                const initialPayloadContents = [
                    { role: "user", parts: [{ text: jarvisInitialPrompt }] },
                    { role: "model", parts: [{ text: "System initialized. JARVIS online and ready." }] },
                    { role: "user", parts: [{ text: "Greet me with your standard initialization message." }] }
                ];

                const payload = { contents: initialPayloadContents };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:streamGenerateContent?key=${apikey_gemini}&alt=sse`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorText = `System error: ${errorData.error?.message || response.statusText}. Please try again later.`;
                    
                    if (response.status === 400 && errorData.error?.message.toLowerCase().includes("api key not valid")) {
                        errorText = "Authentication error: Invalid API key. Please verify system credentials.";
                    } else if (response.status === 403) {
                        errorText = "Authorization error: Access denied. Verify permissions or quota status.";
                    }
                    
                    finalBubbleElement = displayAIMessage({ text: errorText }, true, true);
                    accumulatedGreeting = errorText;
                } else {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let firstChunk = true;

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        
                        const chunkText = decoder.decode(value, { stream: true });
                        const lines = chunkText.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const jsonData = JSON.parse(line.substring(5));
                                    if (jsonData.candidates?.[0]?.content?.parts?.[0]?.text) {
                                        const textPart = jsonData.candidates[0].content.parts[0].text;
                                        accumulatedGreeting += textPart;
                                        
                                        if (firstChunk) {
                                            finalBubbleElement = displayAIMessage({ text: textPart }, false, true);
                                            firstChunk = false;
                                        } else if (finalBubbleElement) {
                                            displayAIMessage({ text: textPart });
                                        }
                                    }
                                } catch (e) {
                                    console.warn("Error parsing stream JSON:", e, "Line:", line);
                                }
                            }
                        }
                    }
                }

                if (!accumulatedGreeting && !finalBubbleElement) {
                    accumulatedGreeting = "JARVIS online. Systems nominal. How may I assist you, Sir?";
                    finalBubbleElement = displayAIMessage({ text: accumulatedGreeting }, false, true);
                }

                chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: jarvisInitialPrompt }] });
                chatHistory.push({ role: "model", parts: [{ text: accumulatedGreeting }] });
                saveChatHistory();
                
                if (finalBubbleElement && accumulatedGreeting.trim() !== "") {
                    addCopyButtonToBubble(finalBubbleElement, accumulatedGreeting);
                }
            } catch (error) {
                console.error("Initialization error:", error);
                let errMsg = 'System error: Initialization failed. Please refresh and try again.';
                
                if (error.message.includes("API Key not set")) {
                    errMsg = "Configuration error: API key required for system operation.";
                }
                
                const errorBubble = displayAIMessage({ text: errMsg }, true, true);
                chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: jarvisInitialPrompt }] });
                chatHistory.push({ role: "model", parts: [{ text: errMsg }] });
                saveChatHistory();
                
                if (errorBubble && errMsg.trim() !== "") {
                    addCopyButtonToBubble(errorBubble, errMsg);
                }
            } finally {
                hideTypingIndicator();
                chatInput.focus();
                updateSendButtonState();
                currentAIResponseElement = null;
            }
        }

        // UI Functions
        function displayUserMessage(message, imageBase64Data) {
            if (!message && !imageBase64Data) return;
            
            const messageElement = document.createElement('div');
            messageElement.className = 'flex justify-end mb-3';
            
            let imageHTML = '';
            if (imageBase64Data) {
                imageHTML = `<img src="${imageBase64Data}" alt="User's image" class="message-image">`;
            }
            
            messageElement.innerHTML = `
                <div class="chat-bubble user-bubble">
                    ${message ? `<p class="break-words">${message}</p>` : ''}
                    ${imageHTML}
                </div>
            `;
            
            chatOutput.appendChild(messageElement);
            scrollToBottom();
        }

        function displayAIMessage(content, isError = false, isStreamStart = false) {
            let textContent = typeof content === 'string' ? content : (content.text || "");
            let imageUrl = typeof content === 'string' ? "" : (content.imageUrl || "");

            if (isStreamStart) {
                const messageElement = document.createElement('div');
                messageElement.className = 'flex justify-start mb-3';
                
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ai-bubble ${isError ? 'error' : ''}`;
                
                const nameTag = document.createElement('div');
                nameTag.className = 'ai-name';
                nameTag.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5 3.87 4 4 0 0 1-1-3.87 4 4 0 0 1 .17-1"></path>
                        <path d="M8 21v-1a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v1"></path>
                        <path d="M12 8a4 4 0 1 0 4 4"></path>
                        <line x1="12" y1="2" x2="12" y2="3"></line>
                        <line x1="21" y1="12" x2="20" y2="12"></line>
                        <line x1="3" y1="12" x2="4" y2="12"></line>
                        <line x1="12" y1="21" x2="12" y2="20"></line>
                    </svg>
                    JARVIS
                `;
                bubble.appendChild(nameTag);
                
                const textSpan = document.createElement('div');
                textSpan.className = 'ai-text-content';
                textSpan.innerHTML = formatTextToHTML(textContent);
                bubble.appendChild(textSpan);
                
                messageElement.appendChild(bubble);
                chatOutput.appendChild(messageElement);
                currentAIResponseElement = textSpan;
                scrollToBottom();
                return bubble;
            } else if (currentAIResponseElement && !imageUrl && !isError) {
                currentAIResponseElement.innerHTML += formatTextToHTML(textContent);
                scrollToBottom();
                return currentAIResponseElement.closest('.ai-bubble');
            } else {
                const messageElement = document.createElement('div');
                messageElement.className = 'flex justify-start mb-3';
                
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ai-bubble ${isError ? 'error' : ''}`;
                
                const nameTag = document.createElement('div');
                nameTag.className = 'ai-name';
                nameTag.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5 3.87 4 4 0 0 1-1-3.87 4 4 0 0 1 .17-1"></path>
                        <path d="M8 21v-1a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v1"></path>
                        <path d="M12 8a4 4 0 1 0 4 4"></path>
                        <line x1="12" y1="2" x2="12" y2="3"></line>
                        <line x1="21" y1="12" x2="20" y2="12"></line>
                        <line x1="3" y1="12" x2="4" y2="12"></line>
                        <line x1="12" y1="21" x2="12" y2="20"></line>
                    </svg>
                    JARVIS
                `;
                bubble.appendChild(nameTag);
                
                let imageHTML = '';
                if (imageUrl) {
                    imageHTML = `<img src="${imageUrl}" alt="JARVIS generated image" class="message-image">`;
                }
                
                bubble.innerHTML += `
                    <div class="ai-text-content">${formatTextToHTML(textContent)}</div>
                    ${imageHTML}
                `;
                
                messageElement.appendChild(bubble);
                chatOutput.appendChild(messageElement);
                
                if (!isStreamStart && !currentAIResponseElement && textContent.trim() !== "") {
                    addCopyButtonToBubble(bubble, textContent);
                }
                
                scrollToBottom();
                return bubble;
            }
        }

        function formatTextToHTML(text) {
            return text
                .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/```([\s\S]*?)```/g, (match, p1) => 
                    `<pre class="bg-slate-800 p-3 rounded-md my-2 text-sm overflow-x-auto"><code>${p1.trim()}</code></pre>`)
                .replace(/`([^`]+)`/g, '<code class="bg-slate-700 px-1.5 py-0.5 rounded text-sm">$1</code>')
                .replace(/\n/g, '<br>');
        }

        function addCopyButtonToBubble(bubbleElement, textToCopy) {
            if (!textToCopy || textToCopy.trim() === "" || !bubbleElement) return;
            
            const existingCopyButton = bubbleElement.querySelector('.copy-button');
            if (existingCopyButton) existingCopyButton.remove();

            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-button';
            copyBtn.title = 'Copy text';
            copyBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
            `;
            
            copyBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                copyToClipboard(textToCopy);
            });
            
            bubbleElement.appendChild(copyBtn);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast("Copied to clipboard");
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast("Failed to copy text");
            });
        }

        function showToast(message) {
            toastNotification.textContent = message;
            toastNotification.classList.add('show');
            setTimeout(() => toastNotification.classList.remove('show'), 2000);
        }

        function showTypingIndicator() {
            typingIndicator.classList.remove('hidden');
        }

        function hideTypingIndicator() {
            typingIndicator.classList.add('hidden');
        }

        function scrollToBottom() {
            chatOutput.scrollTop = chatOutput.scrollHeight;
        }

        function updateSendButtonState() {
            sendButton.disabled = chatInput.value.trim() === '' && !selectedImageBase64;
        }

        function autoResizeTextarea() {
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                updateSendButtonState();
            });
        }

        function clearImagePreview() {
            selectedImageBase64 = null;
            selectedImageFile = null;
            imageInput.value = '';
            imagePreview.src = '#';
            imagePreviewArea.classList.add('hidden');
            updateSendButtonState();
        }

        function showClearChatModal() {
            clearChatModal.classList.add('show');
        }

        function hideClearChatModal() {
            clearChatModal.classList.remove('show');
        }

        function clearChat() {
            chatOutput.innerHTML = '';
            chatHistory = [];
            sessionStorage.removeItem(session_key);
            initializeApp(true);
            showToast("Conversation cleared");
            hideClearChatModal();
        }

        function saveChatHistory() {
            try {
                sessionStorage.setItem(session_key, JSON.stringify(chatHistory));
            } catch (e) {
                console.warn("Failed to save chat history:", e);
            }
        }

        // Event Handlers
        async function handleSendMessage() {
            const messageText = chatInput.value.trim();
            if (messageText === '' && !selectedImageBase64) return;

            currentAIResponseElement = null;
            const currentImageBase64 = selectedImageBase64;
            const currentImageFile = selectedImageFile;

            // Display user message
            displayUserMessage(messageText, currentImageBase64);
            
            // Add to chat history
            const userParts = [];
            if (messageText) userParts.push({ text: messageText });
            if (currentImageBase64 && currentImageFile) {
                userParts.push({
                    inlineData: {
                        mimeType: currentImageFile.type,
                        data: currentImageBase64.split(',')[1]
                    }
                });
            }
            
            chatHistory.push({ role: "user", parts: userParts });
            saveChatHistory();
            
            // Clear input
            chatInput.value = '';
            chatInput.style.height = 'auto';
            clearImagePreview();
            updateSendButtonState();
            
            // Check for image generation request
            const lowerMessageText = messageText.toLowerCase();
            let isImageGenRequest = false;
            let imageGenPrompt = "";
            
            for (const keyword of imageGenerationKeywords) {
                if (lowerMessageText.includes(keyword)) {
                    isImageGenRequest = true;
                    let keywordIndex = lowerMessageText.indexOf(keyword);
                    imageGenPrompt = messageText.substring(keywordIndex + keyword.length).trim();
                    
                    if (imageGenPrompt.startsWith(":") || imageGenPrompt.startsWith(",")) {
                        imageGenPrompt = imageGenPrompt.substring(1).trim();
                    }
                    
                    if (!imageGenPrompt) {
                        imageGenPrompt = "a futuristic AI interface in the style of Iron Man's technology";
                    }
                    break;
                }
            }

            if (isImageGenRequest) {
                await generateImageWithJARVIS(imageGenPrompt);
                chatInput.focus();
                return;
            }
            
            // Process normal message
            showTypingIndicator();
            let accumulatedResponse = "";
            let finalBubbleForCopyButton = null;

            try {
                const apiPayloadContents = [
                    { role: "user", parts: [{ text: jarvisInitialPrompt }] },
                    ...chatHistory.slice(1)
                ];

                const payload = { contents: apiPayloadContents };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:streamGenerateContent?key=${apikey_gemini}&alt=sse`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorText = `System error: ${errorData.error?.message || response.statusText}. Please try again.`;
                    
                    if (response.status === 400 && errorData.error?.message.toLowerCase().includes("api key not valid")) {
                        errorText = "Authentication error: Invalid API key. Please verify system credentials.";
                    } else if (response.status === 403) {
                        errorText = "Authorization error: Access denied. Verify permissions or quota status.";
                    }
                    
                    finalBubbleForCopyButton = displayAIMessage({ text: errorText }, true, true);
                    accumulatedResponse = errorText;
                } else {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let firstChunk = true;

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        
                        const chunkText = decoder.decode(value, { stream: true });
                        const lines = chunkText.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const jsonData = JSON.parse(line.substring(5));
                                    if (jsonData.candidates?.[0]?.content?.parts?.[0]?.text) {
                                        const textPart = jsonData.candidates[0].content.parts[0].text;
                                        accumulatedResponse += textPart;
                                        
                                        if (firstChunk) {
                                            finalBubbleForCopyButton = displayAIMessage({ text: textPart }, false, true);
                                            firstChunk = false;
                                        } else if (finalBubbleForCopyButton) {
                                            displayAIMessage({ text: textPart });
                                        }
                                    }
                                } catch (e) {
                                    console.warn("Error parsing stream JSON:", e, "Line:", line);
                                }
                            }
                        }
                    }
                }

                if (!accumulatedResponse && !finalBubbleForCopyButton) {
                    accumulatedResponse = "Processing complete. How else may I assist you, Sir?";
                    finalBubbleForCopyButton = displayAIMessage({ text: accumulatedResponse }, false, true);
                }

                chatHistory.push({ role: "model", parts: [{ text: accumulatedResponse }] });
                saveChatHistory();
                
                if (finalBubbleForCopyButton && accumulatedResponse.trim() !== "") {
                    addCopyButtonToBubble(finalBubbleForCopyButton, accumulatedResponse);
                }
            } catch (error) {
                console.error("Processing error:", error);
                let errorMsg = 'System error: Processing failed. Please try again.';
                
                if (error.message.includes("API Key not set")) {
                    errorMsg = "Configuration error: API key required for system operation.";
                }
                
                const errorBubble = displayAIMessage({ text: errorMsg }, true, true);
                chatHistory.push({ role: "model", parts: [{ text: errorMsg }] });
                saveChatHistory();
                
                if (errorBubble && errorMsg.trim() !== "") {
                    addCopyButtonToBubble(errorBubble, errorMsg);
                }
            } finally {
                hideTypingIndicator();
                chatInput.focus();
                updateSendButtonState();
                currentAIResponseElement = null;
            }
        }

        async function generateImageWithJARVIS(promptForImage) {
            imageLoaderOverlay.classList.add('show');
            imageLoaderText.textContent = "Processing visual request...";
            
            let jarvisPreText = "Initiating image generation protocol. Processing request now, Sir.";
            const preTextBubble = displayAIMessage({ text: jarvisPreText }, false, false);
            if (jarvisPreText.trim() !== "") addCopyButtonToBubble(preTextBubble, jarvisPreText);

            chatHistory.push({ role: "model", parts: [{ text: jarvisPreText }] });
            saveChatHistory();

            try {
                const payload = {
                    instances: [{ prompt: promptForImage }],
                    parameters: { sampleCount: 1 }
                };
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apikey_gemini}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorText = `Visual generation error: ${errorData.error?.message || response.statusText || "Insufficient resources"}`;
                    
                    if (response.status === 400 && errorData.error?.message.toLowerCase().includes("api key not valid")) {
                        errorText = "Authentication error: Invalid API key for visual generation.";
                    } else if (response.status === 403) {
                        errorText = "Authorization error: Access denied for visual generation services.";
                    }
                    
                    const errorBubble = displayAIMessage({ text: errorText }, true, false);
                    if (errorText.trim() !== "") addCopyButtonToBubble(errorBubble, errorText);
                    
                    chatHistory.push({ role: "model", parts: [{ text: errorText }] });
                    saveChatHistory();
                    return;
                }

                const result = await response.json();
                if (result.predictions?.[0]?.bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    let jarvisPostText = "Visual generation complete. Here is the requested image, Sir.";
                    const imgBubble = displayAIMessage({ text: jarvisPostText, imageUrl: imageUrl }, false, false);
                    
                    if (jarvisPostText.trim() !== "") addCopyButtonToBubble(imgBubble, jarvisPostText);
                    
                    chatHistory.push({
                        role: "model",
                        parts: [
                            { text: jarvisPostText },
                            { text: "[Image generated by JARVIS visual systems]" }
                        ]
                    });
                    saveChatHistory();
                } else {
                    let errorText = "Visual generation failed. Unable to render requested image.";
                    const noImgBubble = displayAIMessage({ text: errorText }, true, false);
                    
                    if (errorText.trim() !== "") addCopyButtonToBubble(noImgBubble, errorText);
                    
                    chatHistory.push({ role: "model", parts: [{ text: errorText }] });
                    saveChatHistory();
                }
            } catch (error) {
                console.error("Visual generation error:", error);
                let errorText = "Critical error in visual generation systems. Please try again.";
                
                if (error.message.includes("API Key not set")) {
                    errorText = "Configuration error: API key required for visual generation.";
                }
                
                const catchBubble = displayAIMessage({ text: errorText }, true, false);
                if (errorText.trim() !== "") addCopyButtonToBubble(catchBubble, errorText);
                
                chatHistory.push({ role: "model", parts: [{ text: errorText }] });
                saveChatHistory();
            } finally {
                imageLoaderOverlay.classList.remove('show');
            }
        }

        function setupEventListeners() {
            // Send message on button click or Enter key
            sendButton.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !sendButton.disabled) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });

            // Image upload handling
            imageInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (file.size > 4 * 1024 * 1024) {
                    displayAIMessage({ text: "Error: Image exceeds maximum size limit of 4MB." }, true, false);
                    clearImagePreview();
                    return;
                }

                selectedImageFile = file;
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    selectedImageBase64 = e.target.result;
                    imagePreview.src = selectedImageBase64;
                    imagePreviewArea.classList.remove('hidden');
                    updateSendButtonState();
                };
                
                reader.readAsDataURL(file);
            });

            removeImageButton.addEventListener('click', clearImagePreview);
            
            // Clear chat functionality
            clearChatButton.addEventListener('click', showClearChatModal);
            confirmClearButton.addEventListener('click', clearChat);
            cancelClearButton.addEventListener('click', hideClearChatModal);
            clearChatModal.addEventListener('click', (e) => {
                if (e.target === clearChatModal) hideClearChatModal();
            });
            
            // Update send button state when input changes
            chatInput.addEventListener('input', updateSendButtonState);
        }
    </script>
</body>
</html>
